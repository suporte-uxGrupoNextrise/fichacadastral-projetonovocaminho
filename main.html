<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Matrícula - Projeto Novo Caminho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        
        /* Cores do Projeto (Verde Esperança e Laranja Cautela) */
        .primary-bg { background-color: #047857; } /* Emerald 700 */
        .primary-text { color: #047857; }
        .accent-bg { background-color: #d97706; } /* Amber 600 */
        .accent-text { color: #d97706; }
        
        .form-step { display: none; animation: fadeIn 0.5s; }
        .form-step.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-input {
            border: 1px solid #cbd5e1;
            transition: all 0.3s;
        }
        .form-input:focus {
            border-color: #047857;
            box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.1);
            outline: none;
        }
        
        /* Estilo para inputs de quantidade na triagem */
        .qty-input {
            text-align: center;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #047857; color: white;
            transition: 0.3s;
        }
        .btn-primary:hover { background-color: #065f46; }
        
        .btn-secondary {
            background-color: #e2e8f0; color: #475569;
            transition: 0.3s;
        }
        .btn-secondary:hover { background-color: #cbd5e1; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #047857;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen py-6 px-4 flex justify-center items-start">

    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <div class="bg-gray-50 p-6 border-b border-gray-200 text-center">
            <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider">ADSA BRASIL</h2>
            <h1 class="text-3xl font-extrabold primary-text mt-1">PROJETO NOVO CAMINHO</h1>
            <p class="text-gray-600 font-medium">Ficha de Matrícula e Triagem</p>
            <div class="mt-2 text-xs text-gray-500 bg-gray-200 inline-block px-3 py-1 rounded-full">
                <i class="fa-brands fa-pix mr-1"></i> Pix: Pixprojetonovocaminho@adsabrasil.org.br
            </div>
        </div>

        <div class="w-full bg-gray-200 h-2">
            <div id="progressBar" class="accent-bg h-2 transition-all duration-500" style="width: 0%"></div>
        </div>

        <form id="admissionForm" class="p-6 md:p-8" novalidate>
            
            <div class="form-step active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-emerald-100 text-emerald-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                        Dados do Recuperando
                    </h2>
                    <div class="text-right">
                        <label class="text-xs font-bold text-gray-500 block">DATA DE ENTRADA</label>
                        <input type="date" name="dataEntrada" class="font-bold text-gray-700 bg-gray-50 border-none focus:ring-0 p-0 text-right" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                        <input type="text" name="nome" class="w-full p-3 rounded-lg form-input uppercase" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data de Nascimento</label>
                        <input type="text" name="dataNascimento" class="w-full p-3 rounded-lg form-input" placeholder="DD/MM/AAAA" oninput="maskDate(this)" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado Civil</label>
                        <select name="estadoCivil" class="w-full p-3 rounded-lg form-input bg-white">
                            <option value="SOLTEIRO">SOLTEIRO(A)</option>
                            <option value="CASADO">CASADO(A)</option>
                            <option value="DIVORCIADO">DIVORCIADO(A)</option>
                            <option value="VIUVO">VIÚVO(A)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Naturalidade (Cidade/Estado)</label>
                        <input type="text" name="naturalidade" class="w-full p-3 rounded-lg form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nacionalidade</label>
                        <input type="text" name="nacionalidade" value="BRASILEIRA" class="w-full p-3 rounded-lg form-input">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Mãe</label>
                        <input type="text" name="nomeMae" class="w-full p-3 rounded-lg form-input uppercase" required>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Pai</label>
                        <input type="text" name="nomePai" class="w-full p-3 rounded-lg form-input uppercase">
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-3 border-b pb-2">Documentação</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" name="rg" placeholder="RG" class="p-3 rounded-lg form-input" required>
                    <input type="text" name="cpf" placeholder="CPF" class="p-3 rounded-lg form-input" oninput="maskCPF(this)" required>
                    <input type="text" name="cartaoSus" placeholder="Cartão SUS" class="p-3 rounded-lg form-input">
                    <input type="text" name="ctps" placeholder="Carteira de Trabalho (CTPS)" class="p-3 rounded-lg form-input md:col-span-3">
                </div>
            </div>

            <div class="form-step">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="bg-emerald-100 text-emerald-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                    Endereço e Contato
                </h2>

                <div class="grid grid-cols-1 gap-4">
                     <div class="flex gap-4">
                        <input type="text" name="cep" id="cep" placeholder="CEP" class="w-1/3 p-3 rounded-lg form-input" oninput="maskCEP(this)" onblur="buscarCEP()">
                        <div class="w-2/3 flex items-center text-sm text-gray-500" id="cepMsg">Digite o CEP para buscar</div>
                    </div>
                    
                    <input type="text" name="rua" id="rua" placeholder="Logradouro" class="w-full p-3 rounded-lg form-input bg-gray-50" readonly>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="numero" placeholder="Número" class="p-3 rounded-lg form-input">
                        <input type="text" name="bairro" id="bairro" placeholder="Bairro" class="p-3 rounded-lg form-input bg-gray-50" readonly>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="cidade" id="cidade" placeholder="Cidade" class="p-3 rounded-lg form-input bg-gray-50" readonly>
                        <input type="text" name="uf" id="uf" placeholder="UF" class="p-3 rounded-lg form-input bg-gray-50" readonly>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Telefone Fixo</label>
                            <input type="tel" name="telFixo" class="w-full p-3 rounded-lg form-input" oninput="maskPhone(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Celular (WhatsApp)</label>
                            <input type="tel" name="celular" class="w-full p-3 rounded-lg form-input" oninput="maskPhone(this)" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-step">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="bg-emerald-100 text-emerald-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">3</span>
                    Histórico Clínico (CID)
                </h2>

                <div class="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
                    <h3 class="font-bold text-red-800 mb-2">Motivo da Internação / Substâncias</h3>
                    <p class="text-sm text-red-600 mb-3">Selecione as substâncias de uso ou quadros clínicos (Baseado no CID-10):</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2 bg-white p-2 rounded border">
                            <input type="checkbox" name="vicios[]" value="ALCOOL (F10)" class="form-checkbox text-red-600">
                            <span class="text-sm">Álcool (F10)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-white p-2 rounded border">
                            <input type="checkbox" name="vicios[]" value="MACONHA (F12)" class="form-checkbox text-red-600">
                            <span class="text-sm">Maconha (F12)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-white p-2 rounded border">
                            <input type="checkbox" name="vicios[]" value="COCAINA (F14)" class="form-checkbox text-red-600">
                            <span class="text-sm">Cocaína (F14)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-white p-2 rounded border">
                            <input type="checkbox" name="vicios[]" value="CIGARRO (F17)" class="form-checkbox text-red-600">
                            <span class="text-sm">Tabaco/Cigarro (F17)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-white p-2 rounded border">
                            <input type="checkbox" name="vicios[]" value="CRACK (F19)" class="form-checkbox text-red-600">
                            <span class="text-sm">Crack (F19)</span>
                        </label>
                         <label class="flex items-center space-x-2 bg-white p-2 rounded border">
                            <input type="checkbox" name="vicios[]" value="DEPRESSAO (F32)" class="form-checkbox text-red-600">
                            <span class="text-sm">Depressão (F32)</span>
                        </label>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Medicamentos em uso:</label>
                        <textarea name="medicamentos" rows="2" class="w-full p-3 rounded-lg form-input" placeholder="Liste os remédios e horários..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Histórico de Tratamentos (Hospitais, CAPS, Clínicas):</label>
                        <textarea name="historicoTratamento" rows="3" class="w-full p-3 rounded-lg form-input" placeholder="Ex: Internado na Santa Casa em 2022; Acompanhamento no CAPS..."></textarea>
                    </div>
                </div>
            </div>

            <div class="form-step">
                <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <span class="bg-emerald-100 text-emerald-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">4</span>
                    Triagem de Pertences
                </h2>
                <p class="text-sm text-gray-500 mb-6">Informe a quantidade exata de itens trazidos na entrada.</p>

                <h3 class="font-bold text-gray-700 border-b pb-1 mb-3">Vestuário e Cama</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div><label class="text-xs text-gray-500">Camisas</label><input type="number" name="qtdCamisas" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Camisetas</label><input type="number" name="qtdCamisetas" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Calças</label><input type="number" name="qtdCalcas" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Bermudas</label><input type="number" name="qtdBermudas" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Cuecas</label><input type="number" name="qtdCuecas" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Meias</label><input type="number" name="qtdMeias" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Tênis/Sapatos</label><input type="number" name="qtdCalcados" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Chinelos</label><input type="number" name="qtdChinelos" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Lençol/Toalha</label><input type="number" name="qtdCamaBanho" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Cobertor</label><input type="number" name="qtdCobertor" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                </div>

                <h3 class="font-bold text-gray-700 border-b pb-1 mb-3">Higiene e Objetos Pessoais</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="text-xs text-gray-500">Kit Higiene</label><input type="number" name="qtdHigiene" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Bíblia/Harpa</label><input type="number" name="qtdBiblia" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div><label class="text-xs text-gray-500">Celular</label><input type="number" name="qtdCelular" min="0" class="w-full p-2 rounded form-input qty-input" placeholder="0"></div>
                    <div class="md:col-span-4"><label class="text-xs text-gray-500">Outros Pertences (Descrever)</label><input type="text" name="outrosPertences" class="w-full p-2 rounded form-input" placeholder="Ex: Carteira, Documentos, Relógio..."></div>
                </div>
            </div>

            <div class="form-step">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="bg-emerald-100 text-emerald-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">5</span>
                    Dados dos Responsáveis
                </h2>

                <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-3"><i class="fa-solid fa-car"></i> Responsável que Conduziu (Família)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="respConduziuNome" placeholder="Nome Completo" class="w-full p-3 rounded-lg form-input md:col-span-2" required>
                        <input type="text" name="respConduziuRg" placeholder="RG" class="p-3 rounded-lg form-input">
                        <input type="text" name="respConduziuCpf" placeholder="CPF" class="p-3 rounded-lg form-input" oninput="maskCPF(this)">
                        <input type="text" name="respConduziuTel" placeholder="Telefone/Zap" class="p-3 rounded-lg form-input" oninput="maskPhone(this)" required>
                    </div>
                </div>

                <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                    <h3 class="font-bold text-emerald-800 mb-3"><i class="fa-solid fa-hand-holding-dollar"></i> Responsável Financeiro/Contribuinte</h3>
                    
                    <label class="flex items-center mb-4">
                        <input type="checkbox" id="checkMesmoResp" class="mr-2 h-4 w-4 text-emerald-600" onchange="copiarResponsavel()">
                        <span class="text-sm text-gray-600">Mesma pessoa acima</span>
                    </label>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="respFinanNome" id="respFinanNome" placeholder="Nome Completo" class="w-full p-3 rounded-lg form-input md:col-span-2">
                        <input type="text" name="respFinanRg" id="respFinanRg" placeholder="RG" class="p-3 rounded-lg form-input">
                        <input type="text" name="respFinanCpf" id="respFinanCpf" placeholder="CPF" class="p-3 rounded-lg form-input" oninput="maskCPF(this)">
                    </div>
                </div>
            </div>

            <div class="form-step">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span class="bg-emerald-100 text-emerald-800 w-8 h-8 rounded-full flex items-center justify-center text-sm">6</span>
                    Termos e Confirmação
                </h2>

                <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-200 text-sm text-gray-800 mb-6 h-48 overflow-y-auto">
                    <h4 class="font-bold mb-2">TERMO DE COMPROMISSO E REGRAS GERAIS</h4>
                    <p class="mb-2">1. O período de tratamento é de <strong>9 meses</strong>: 6 meses de tratamento integral e 3 meses com liberdades condicionais, mediante bom testemunho.</p>
                    <p class="mb-2">2. As normas deverão ser rigorosamente seguidas pelo participante e seus familiares.</p>
                    <p class="mb-2">3. <strong>O valor contribuído NÃO será reembolsado</strong>, pois o projeto não possui fins lucrativos.</p>
                    <p class="mb-2">4. Serviço Voluntário: Conforme Lei nº 9.608/1998, as atividades realizadas não geram vínculo empregatício.</p>
                    <p>Declaro estar ciente e de acordo com todas as regras acima.</p>
                </div>

                <label class="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer mb-6">
                    <input type="checkbox" required class="h-5 w-5 text-emerald-600">
                    <span class="text-gray-700 font-medium">Li e concordo com os termos de internação e voluntariado.</span>
                </label>

                <div class="border-t pt-6">
                    <label class="block mb-2 font-bold text-gray-700">Foto do Recuperando (Obrigatório)</label>
                    <div class="flex items-center gap-4">
                        <label class="cursor-pointer bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition">
                            <i class="fa-solid fa-camera mr-2"></i> Tirar Foto
                            <input type="file" name="foto" id="fotoInput" accept="image/*" capture="user" class="hidden" required>
                        </label>
                        <span id="fileName" class="text-sm text-gray-500">Nenhuma foto selecionada</span>
                    </div>
                    <img id="preview" class="mt-4 h-32 w-32 object-cover rounded-lg hidden border-2 border-emerald-500">
                </div>
            </div>

            <div class="flex justify-between mt-8 pt-4 border-t border-gray-100">
                <button type="button" id="prevBtn" onclick="nextPrev(-1)" class="py-2 px-6 rounded-lg font-semibold btn-secondary hidden">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Voltar
                </button>
                <button type="button" id="nextBtn" onclick="nextPrev(1)" class="py-2 px-6 rounded-lg font-semibold btn-primary ml-auto">
                    Próximo <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
            
            <div id="loading" class="hidden flex justify-center mt-4"><div class="loader"></div></div>
            <div id="resultMsg" class="hidden mt-4 p-4 rounded text-center font-bold"></div>

        </form>
    </div>

<script>
    // URL do Script Google (Deve ser inserida aqui)
    const GOOGLE_SCRIPT_URL = 'URL_DO_SEU_GOOGLE_APPS_SCRIPT_AQUI';

    let currentStep = 0;
    const steps = document.getElementsByClassName("form-step");
    
    // Inicialização
    document.addEventListener("DOMContentLoaded", () => {
        showStep(currentStep);
        // Define a data de hoje como padrão para entrada
        document.querySelector('input[name="dataEntrada"]').valueAsDate = new Date();
    });

    function showStep(n) {
        // Oculta todas as etapas
        for (let step of steps) step.classList.remove("active");
        
        // Mostra a atual
        steps[n].classList.add("active");
        
        // Atualiza botões
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        
        prevBtn.classList.toggle("hidden", n === 0);
        
        if (n === steps.length - 1) {
            nextBtn.innerHTML = 'Finalizar Matrícula <i class="fa-solid fa-check ml-2"></i>';
            nextBtn.classList.replace("btn-primary", "btn-primary"); // Mantém estilo
        } else {
            nextBtn.innerHTML = 'Próximo <i class="fa-solid fa-arrow-right ml-2"></i>';
        }

        // Barra de progresso
        const progress = ((n + 1) / steps.length) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
    }

    function nextPrev(n) {
        // Se estiver avançando, valida
        if (n === 1 && !validateForm()) return false;
        
        // Se for o último passo e clicar em próximo, envia
        if (currentStep >= steps.length - 1 && n === 1) {
            submitForm();
            return false;
        }

        currentStep += n;
        showStep(currentStep);
        // Scroll para o topo
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateForm() {
        let valid = true;
        const inputs = steps[currentStep].querySelectorAll("input[required], select[required]");
        
        inputs.forEach(input => {
            if (!input.value) {
                input.classList.add("border-red-500", "bg-red-50");
                valid = false;
            } else {
                input.classList.remove("border-red-500", "bg-red-50");
            }
        });

        if (!valid) alert("Por favor, preencha os campos obrigatórios.");
        return valid;
    }

    // --- Lógica de Negócio Específica ---

    function copiarResponsavel() {
        const check = document.getElementById('checkMesmoResp');
        if (check.checked) {
            document.getElementById('respFinanNome').value = document.getElementsByName('respConduziuNome')[0].value;
            document.getElementById('respFinanRg').value = document.getElementsByName('respConduziuRg')[0].value;
            document.getElementById('respFinanCpf').value = document.getElementsByName('respConduziuCpf')[0].value;
        } else {
            document.getElementById('respFinanNome').value = '';
            document.getElementById('respFinanRg').value = '';
            document.getElementById('respFinanCpf').value = '';
        }
    }

    // --- Busca de CEP ---
    async function buscarCEP() {
        const cep = document.getElementById('cep').value.replace(/\D/g, '');
        if (cep.length === 8) {
            document.getElementById('cepMsg').innerText = "Buscando...";
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    document.getElementById('rua').value = data.logradouro;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('cidade').value = data.localidade;
                    document.getElementById('uf').value = data.uf;
                    document.getElementById('cepMsg').innerText = "Endereço encontrado!";
                } else {
                    document.getElementById('cepMsg').innerText = "CEP não encontrado.";
                }
            } catch (e) { console.error(e); }
        }
    }

    // --- Máscaras ---
    const maskDate = (el) => el.value = el.value.replace(/\D/g,'').replace(/(\d{2})(\d)/,'$1/$2').replace(/(\d{2})(\d)/,'$1/$2').replace(/(\d{4})\d+?$/,'$1');
    const maskCPF = (el) => el.value = el.value.replace(/\D/g,'').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').replace(/(-\d{2})\d+?$/, '$1');
    const maskCEP = (el) => el.value = el.value.replace(/\D/g,'').replace(/(\d{5})(\d)/,'$1-$2').replace(/(-\d{3})\d+?$/, '$1');
    const maskPhone = (el) => {
        let r = el.value.replace(/\D/g, "");
        r = r.replace(/^0/, "");
        if (r.length > 10) {
            r = r.replace(/^(\d\d)(\d{5})(\d{4}).*/, "($1) $2-$3");
        } else if (r.length > 5) {
            r = r.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, "($1) $2-$3");
        } else if (r.length > 2) {
            r = r.replace(/^(\d\d)(\d{0,5}).*/, "($1) $2");
        } else {
            r = r.replace(/^(\d*)/, "($1");
        }
        el.value = r;
    }

    // --- Foto Preview ---
    const fotoInput = document.getElementById('fotoInput');
    fotoInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
                document.getElementById('preview').classList.remove('hidden');
                document.getElementById('fileName').innerText = "Foto carregada!";
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    // --- Envio ---
    function submitForm() {
        if(GOOGLE_SCRIPT_URL.includes("URL_DO_SEU")) {
            alert("Erro de Configuração: Insira a URL do Google Script no código.");
            return;
        }

        const form = document.getElementById('admissionForm');
        const loader = document.getElementById('loading');
        const nextBtn = document.getElementById('nextBtn');
        const resultMsg = document.getElementById('resultMsg');

        // Prepara dados e foto
        const file = fotoInput.files[0];
        if(!file) { alert("A foto é obrigatória."); return; }

        loader.classList.remove('hidden');
        nextBtn.classList.add('hidden');

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
            const base64Info = e.target.result.split(',');
            
            const formData = new FormData(form);
            const obj = {};
            formData.forEach((value, key) => {
                // Lógica para agrupar checkboxes de vícios
                if(obj[key]) {
                    if(!Array.isArray(obj[key])) obj[key] = [obj[key]];
                    obj[key].push(value);
                } else {
                    obj[key] = value;
                }
            });

            // Tratamento especial para array de vicios
            if(Array.isArray(obj['vicios[]'])) obj['vicios'] = obj['vicios[]'].join(', ');
            else if(obj['vicios[]']) obj['vicios'] = obj['vicios[]'];
            delete obj['vicios[]'];

            obj.fotoName = file.name;
            obj.fotoMime = file.type;
            obj.fotoBase64 = base64Info[1];

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(obj)
            })
            .then(r => r.json())
            .then(data => {
                loader.classList.add('hidden');
                if(data.result === 'success') {
                    resultMsg.innerHTML = "Matrícula realizada com sucesso!<br>Bem-vindo ao Novo Caminho.";
                    resultMsg.className = "mt-4 p-4 rounded text-center font-bold bg-green-100 text-green-800";
                    resultMsg.classList.remove('hidden');
                    form.reset();
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(err => {
                loader.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                resultMsg.innerText = "Erro ao enviar: " + err.message;
                resultMsg.className = "mt-4 p-4 rounded text-center font-bold bg-red-100 text-red-800";
                resultMsg.classList.remove('hidden');
            });
        };
    }
</script>
</body>
</html>
